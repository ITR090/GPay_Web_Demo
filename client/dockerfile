# ====================
# STAGE 1: Build the React Application
# ====================
FROM node:20-alpine AS build

# Set the working directory inside the container
WORKDIR /client

# Copy package.json and package-lock.json first to leverage Docker cache
# This layer only changes when dependencies change, speeding up builds
COPY package*.json ./

# Install dependencies 
RUN npm install

# Copy the rest of the application source code
COPY . .

# Build the React application for production (assuming 'npm run build' outputs to a 'dist' or 'build' folder)
# NOTE: If your build command/output directory is different (e.g., 'yarn build'), change this line.
RUN npm run build

# ====================
# STAGE 2: Serve with Nginx (Production-Ready)
# ====================
# Use a lightweight, stable Nginx image
FROM nginx:stable-alpine

# Remove default nginx static assets
RUN rm -rf /usr/share/nginx/html/*

# Copy the custom Nginx configuration file
COPY ./nginx_config/default.conf ./etc/nginx/conf.d/default.conf
COPY ./nginx_config/nginx.conf ./etc/nginx/nginx.conf

# Copy the compiled static files from the build stage to Nginx's web root
# NOTE: Change '/client/build' to '/client/dist' or whatever your 'npm run build' command outputs to.
COPY --from=build /client/dist /usr/share/nginx/html

# Cloud Run expects the service to listen on the port specified by the $PORT environment variable.
# Although Nginx is serving, we'll expose 80, but configure Nginx in nginx.conf to use $PORT.
EXPOSE 8080

# Command to start Nginx in the foreground
CMD ["nginx", "-g", "daemon off;"]